# TechStore REST API Documentation

## Общая информация

Сервис предоставляет REST API для интернет-магазина техники.

  * **Base URL**: `http://localhost:8080/api/v1`
  * **Версия API**: 1.0
  * **Формат данных**: JSON

### Аутентификация и Авторизация

API использует JWT (JSON Web Token) для безопасности.
Для доступа к защищенным эндпоинтам необходимо передавать токен в заголовке `Authorization`.

**Формат заголовка:**

```http
Authorization: Bearer <ваш_токен>
```

### Пагинация и Сортировка

Эндпоинты, возвращающие списки данных, поддерживают стандартную пагинацию Spring Data.
**Параметры запроса (Query Params):**

  * `page`: Номер страницы (начинается с 0, по умолчанию 0).
  * `size`: Количество элементов на странице (по умолчанию 20).
  * `sort`: Параметры сортировки в формате `поле,направление` (например, `price,desc`).

### Обработка ошибок

В случае возникновения исключений сервер возвращает унифицированный объект ошибки.

**Пример ответа при ошибке:**

```json
{
  "status": 400,
  "message": "Описание ошибки",
  "timestamp": "2024-12-01T12:00:00.000+00:00"
}
```

**Статус-коды:**

  * `200 OK` - Успешный запрос.
  * `400 Bad Request` - Ошибка валидации или нарушение бизнес-логики.
  * `401 Unauthorized` - Отсутствует или невалиден JWT токен.
  * `403 Forbidden` - Недостаточно прав для выполнения операции.
  * `404 Not Found` - Ресурс не найден.
  * `500 Internal Server Error` - Внутренняя ошибка сервера.

-----

## 1\. Аутентификация (Auth)

### Регистрация пользователя

Создает нового пользователя с ролью `ROLE_USER`.

  * **URL**: `/auth/sign-up`
  * **Method**: `POST`
  * **Доступ**: Публичный

**Тело запроса (JSON):**

```json
{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "StrongPassword123",
  "confirmPassword": "StrongPassword123",
  "firstName": "John",
  "lastName": "Doe",
  "phone": "+1234567890"
}
```

**Ответ (200 OK):**
Возвращает объект `UserDTO` созданного пользователя.

### Вход в систему (Получение токена)

Проверяет учетные данные и возвращает JWT токен.

  * **URL**: `/auth/sign-in`
  * **Method**: `POST`
  * **Доступ**: Публичный

**Тело запроса (JSON):**

```json
{
  "username": "johndoe",
  "password": "StrongPassword123"
}
```

**Ответ (200 OK):**

```json
{
  "token": "eyJhbGciOiJIUzI1NiJ9..."
}
```

-----

## 2\. Пользователи (Users)

### Получение списка всех пользователей

  * **URL**: `/users`
  * **Method**: `GET`
  * **Доступ**: Требуется аутентификация

**Ответ:** Page\<UserDTO\>

### Получение профиля текущего пользователя

Возвращает данные пользователя, чей токен был передан в заголовке.

  * **URL**: `/users/profile`
  * **Method**: `GET`
  * **Доступ**: Требуется аутентификация

### Получение информации о пользователе по ID

  * **URL**: `/users/{id}`
  * **Method**: `GET`
  * **Доступ**: Требуется аутентификация

### Обновление данных пользователя

Пользователь может обновлять только свой профиль. Администратор может обновлять любой.
Также проверяется совпадение паролей при смене.

  * **URL**: `/users/{id}`
  * **Method**: `PATCH`
  * **Доступ**: Владелец аккаунта или `ROLE_ADMIN`

**Тело запроса:** Аналогично регистрации (`SaveUserDTO`).

### Удаление пользователя

  * **URL**: `/users/{id}`
  * **Method**: `DELETE`
  * **Доступ**: Владелец аккаунта или `ROLE_ADMIN`

### Назначение роли администратора

  * **URL**: `/users/{id}/assign-admin`
  * **Method**: `POST`
  * **Доступ**: Только `ROLE_ADMIN`

-----

## 3\. Каталог (Catalog & Favorites)

### Получение категорий

  * **URL**: `/categories`
  * **Method**: `GET`
  * **Доступ**: Публичный

### Получение брендов

  * **URL**: `/brands`
  * **Method**: `GET`
  * **Доступ**: Публичный

### Поиск товаров (Фильтрация)

Позволяет искать товары по множеству критериев.

  * **URL**: `/products`
  * **Method**: `GET`
  * **Доступ**: Публичный

**Параметры запроса (Query Params):**

  * `query` (String): Поиск по названию или описанию (LIKE).
  * `minPrice` (BigDecimal): Минимальная цена.
  * `maxPrice` (BigDecimal): Максимальная цена.
  * `brandId` (List\<Integer\>): Список ID брендов (можно указывать несколько раз: `?brandId=1&brandId=2`).
  * `categoryId` (Integer): ID категории.
  * `inStock` (Boolean): Если `true`, возвращает только товары с количеством \> 0.
  * `minRating` (BigDecimal): Фильтр по среднему рейтингу.

**Ответ:** Page\<ProductDTO\>

### Детальная информация о товаре

Возвращает расширенную информацию, включая характеристики и список изображений.

  * **URL**: `/products/{id}`
  * **Method**: `GET`
  * **Доступ**: Публичный

### Работа с избранным (Favorites)

#### Получить избранные товары

  * **URL**: `/favorites`
  * **Method**: `GET`
  * **Доступ**: Требуется аутентификация
    **Ответ:** Page\<ProductDTO\>

#### Переключить избранное (Toggle)

Добавляет товар в избранное, если его нет, или удаляет, если он уже там.

  * **URL**: `/favorites/{productId}`
  * **Method**: `POST`
  * **Доступ**: Требуется аутентификация

-----

## 4\. Корзина (Cart)

Данные корзины хранятся в Redis. Время жизни записи (TTL): 7 дней.

### Получить корзину

  * **URL**: `/cart`
  * **Method**: `GET`
  * **Доступ**: Требуется аутентификация

**Ответ (CartDTO):**

```json
{
  "items": [
    {
      "productId": 1,
      "productTitle": "Laptop",
      "quantity": 2,
      "pricePerUnit": 1000.00,
      "imageUrl": "http://..."
    }
  ],
  "totalPrice": 2000.00,
  "totalQuantity": 2
}
```

### Добавить товар в корзину

Если товар уже есть, количество увеличивается.

  * **URL**: `/cart/add`
  * **Method**: `POST`
  * **Доступ**: Требуется аутентификация
  * **Query Params**:
      * `productId` (Long): ID товара.
      * `quantity` (Integer): Количество (по умолчанию 1).

### Обновить количество товара

  * **URL**: `/cart/update`
  * **Method**: `PATCH`
  * **Query Params**:
      * `productId` (Long): ID товара.
      * `quantity` (Integer): Новое количество.

### Удалить товар из корзины

  * **URL**: `/cart/remove/{productId}`
  * **Method**: `DELETE`

### Очистить корзину

  * **URL**: `/cart/clear`
  * **Method**: `DELETE`

-----

## 5\. Сравнение товаров (Comparison)

Хранится в Redis. TTL: 1 день.
**Ограничение**: Максимум 4 товара в списке сравнения.

### Получить список сравнения

  * **URL**: `/comparison`
  * **Method**: `GET`
    **Ответ:** List\<ProductDetailsDTO\>

### Переключить товар в сравнении (Toggle)

Добавляет или удаляет товар. Выбрасывает ошибку 400, если попытка добавить 5-й товар.

  * **URL**: `/comparison/{productId}`
  * **Method**: `POST`

### Очистить список сравнения

  * **URL**: `/comparison/clear`
  * **Method**: `DELETE`

-----

## 6\. Заказы (Orders)

### Оформление заказа

Создает заказ на основе содержимого текущей корзины пользователя в Redis.
При успешном создании корзина очищается, количество товара на складе уменьшается, и отправляется событие `order-placed` в Kafka (которое инициирует отправку email).

  * **URL**: `/orders`
  * **Method**: `POST`
  * **Query Params**:
      * `deliveryAddress` (String): Обязательно.
      * `contactPhone` (String): Опционально (иначе берется из профиля).

### Оплата заказа

Имитация оплаты. Переводит статус заказа из `CREATED` в `PAID`.
Доступно только владельцу заказа.

  * **URL**: `/orders/{id}/pay`
  * **Method**: `POST`

### История заказов

  * **URL**: `/orders`
  * **Method**: `GET`
    **Ответ:** List\<OrderDTO\>

### Информация о конкретном заказе

  * **URL**: `/orders/{id}`
  * **Method**: `GET`

-----

## 7\. Отзывы (Reviews)

### Добавить отзыв

Пользователь может оставить отзыв **только** при соблюдении условий:

1.  Пользователь купил этот товар (есть заказ со статусом `COMPLETED` или `PAID`).
2.  Пользователь еще не оставлял отзыв на этот товар.

<!-- end list -->

  * **URL**: `/reviews`
  * **Method**: `POST`

**Тело запроса:**

```json
{
  "productId": 1,
  "rating": 5, // от 1 до 5
  "comment": "Отличный товар"
}
```

### Получить отзывы товара

  * **URL**: `/reviews/product/{productId}`
  * **Method**: `GET`
  * **Параметры**: Поддерживает пагинацию.

### Удалить отзыв

Пользователь может удалить только свой отзыв. Администратор может удалить любой.

  * **URL**: `/reviews/{reviewId}`
  * **Method**: `DELETE`
